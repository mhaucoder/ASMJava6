<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org" th:replace="~{/admin/layouts/layout :: dynamic(~{::body})}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">Movies Play</h1>

    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">DataTables Movies Play</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Movie</th>
                            <th>Theater</th>
                            <th>Room</th>
                            <th>Start Day</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item: ${list}" th:object="${item}">
                            <td>[[*{id}]]</td>
                            <td>[[*{movie.name}]]</td>
                            <td>[[*{roomMp.movietheaterRoom.name}]]</td>
                            <td>[[*{roomMp.name}]]</td>
                            <td>[[*{startDay}]]</td>
                            <td>[[*{startTime}]]</td>
                            <td th:id="'end-time-' + ${item.id}"></td>
                            <td class="d-flex justify-content-center">
                                <a th:href="@{|/movies/admin/movie-play/edit/*{id}|}" class="btn btn-user">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
                                        <style>
                                            svg {
                                                fill: #858796
                                            }
                                        </style>
                                        <path
                                            d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z" />
                                    </svg>
                                </a>
                                <a th:href="@{|/movies/admin/movie-play/delete/*{id}|}" class="btn btn-user deleteBtn">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512">
                                        <style>
                                            svg {
                                                fill: #858796
                                            }
                                        </style>
                                        <path
                                            d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        var deleteButtons = document.getElementsByClassName("deleteBtn");
        Array.from(deleteButtons).forEach(function (button) {
            button.addEventListener("click", function (e) {
                var confirmed = confirm("Are you sure you want to delete?");
                if (!confirmed) {
                    e.preventDefault();
                }
            });
        });
    </script>

    <script th:inline="javascript">
        $(document).ready(function () {

            function calculateEndTime(startTime, duration, id) {
                if (!startTime || isNaN(duration)) {
                    return;
                }

                const [startHour, startMinute] = startTime.split(":").map(Number);
                const startTimeObj = new Date();
                startTimeObj.setHours(startHour, startMinute, 0);

                const endTimeObj = new Date(startTimeObj.getTime() + (duration * 60 * 60 * 1000));

                // Format the end time to HH:mm format
                const endHour = endTimeObj.getHours().toString().padStart(2, "0");
                const endMinute = endTimeObj.getMinutes().toString().padStart(2, "0");
                const endTime = `${endHour}:${endMinute}`;
                console.log(endTime);
                console.log("#end-time-" + id);
                $("#end-time-" + id).val(endTime);
            }

            $("tr").each(function () {
                var id = $(this).find("td:first-child").text();
                if (!isNaN(parseInt(id))) {
                    var startTime = $(this).find("td:nth-child(6)").text();
                    var duration = NaN;
                    $.ajax({
                        url: "/rest/moviesplay/" + id,
                        type: "GET",
                        dataType: "json",
                        success: function (moviePlay) {
                            duration = moviePlay.movie.duration;
                            if (!isNaN(duration)) {
                                calculateEndTime(startTime, duration, id);
                            }
                        },
                        error: function (error) {
                            duration = NaN;
                            console.error("Error fetching moviePlay:", error);
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>